<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight - Your AI Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700;800&family=Orbitron:wght@400;500;700;900&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': 'rgb(var(--brand-primary) / <alpha-value>)',      
              'surface-main': 'rgb(var(--surface-main) / <alpha-value>)',       
              'surface-chat-area': 'rgb(var(--surface-chat-area) / <alpha-value>)', 
              'surface-user-bubble-bg': 'rgb(var(--surface-user-bubble-bg-val) / <alpha-value>)', 
              'text-primary': 'rgb(var(--text-primary) / <alpha-value>)',         
              'text-secondary': 'rgb(var(--text-secondary) / <alpha-value>)',           
              'text-subtle': 'rgb(var(--text-subtle) / <alpha-value>)',
              'border-default': 'rgb(var(--border-default) / <alpha-value>)',
              'border-light': 'rgb(var(--border-light) / <alpha-value>)',
              'interactive-hover': 'rgb(var(--interactive-hover) / <alpha-value>)',
              'brand-send-active': '#6366F1', // Indigo-500
              'brand-send-hover': '#4F46E5', // Indigo-600
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              poppins: ['Poppins', 'sans-serif'],
              serif: ['Merriweather', 'serif'],
              'playfair-display': ['"Playfair Display"', 'serif'],
              orbitron: ['Orbitron', 'sans-serif'],
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
              'scale-in-subtle': 'scaleInSubtle 0.35s ease-out forwards',
              'button-press': 'buttonPress 0.2s ease-out',
              'spin-fast': 'spin 0.5s linear infinite',
              'shimmer-animation': 'shimmer-animation 2.7s linear infinite',
            },
            keyframes: {
              fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' }, },
              scaleInSubtle: { '0%': { opacity: '0.5', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' }, },
              buttonPress: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.96)'}, '100%': { transform: 'scale(1)' }, },
              'shimmer-animation': { from: { backgroundPosition: '200% center' }, to: { backgroundPosition: '-200% center' } },
            },
            boxShadow: {
                'card': '0 6px 20px rgba(var(--text-primary), 0.04), 0 3px 8px rgba(var(--text-primary),0.02)', 
                'header': '0 1px 2px rgba(var(--text-primary), 0.03), 0 1px 1px rgba(var(--text-primary), 0.015)',
                'chat-window': '0 15px 50px -8px rgba(var(--text-primary), 0.08), 0 8px 25px -8px rgba(var(--text-primary),0.05)',
            },
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      @layer base {
        :root {
          --brand-primary: 99 102 241; /* Indigo-500 */
          --surface-main: 249 250 251; /* Gray-50 */
          --surface-chat-area: 255 255 255; 
          --surface-user-bubble-bg-val: 224 231 255; /* Indigo-100 */
          --text-primary: 31 41 55; /* Gray-800 */
          --text-secondary: 55 65 81; /* Gray-700 */
          --text-subtle: 107 114 128; /* Gray-500 */
          --border-default: 229 231 235; /* Gray-200 */
          --border-light: 243 244 246; /* Gray-100 */
          --interactive-hover: 229 231 235; /* Gray-200 */
        }
        html, body, #root { @apply h-full overflow-hidden bg-surface-main; }
        body { @apply font-sans text-text-primary m-0; }
        .chat-messages-container::-webkit-scrollbar { width: 0px; } 
        .chat-messages-container { scrollbar-width: none; }
      }
      @layer components {
        .shimmer-black-text {
          @apply bg-clip-text text-transparent animate-shimmer-animation;
          background-image: linear-gradient(90deg, #000, #4a5568, #fff, #4a5568, #000);
          background-size: 200% auto;
        }
        .content-editable-input { @apply pt-2 pl-3 pr-3 pb-2; } .content-editable-input:empty:before { content: attr(data-placeholder); @apply text-text-subtle cursor-text; }
        .content-editable-input::-webkit-scrollbar { width: 5px; } .content-editable-input::-webkit-scrollbar-track { background: transparent; } .content-editable-input::-webkit-scrollbar-thumb { background-color: rgba(var(--text-subtle), 0.25); border-radius: 10px; }
        .image-preview-container-input { @apply flex flex-wrap gap-2 p-2 mb-1.5 max-h-28 overflow-y-auto border-b border-gray-200; scrollbar-width: thin; scrollbar-color: theme('colors.slate.300') theme('colors.slate.100'); }
        .image-preview-container-input::-webkit-scrollbar { @apply w-1.5 h-1.5; } .image-preview-container-input::-webkit-scrollbar-track { @apply bg-slate-100 rounded-full; } .image-preview-container-input::-webkit-scrollbar-thumb { @apply bg-slate-300 rounded-full hover:bg-slate-400; }
      }
    </style>
</head>
<body class="p-0 sm:p-4">
    <div id="root" class="h-full">
        <div class="w-full h-full flex flex-col bg-white md:rounded-xl shadow-chat-window overflow-hidden">
            <header class="p-3 flex items-center justify-between flex-shrink-0 bg-white border-b border-border-light shadow-header"><div class="flex items-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" class="w-7 h-7 text-indigo-500"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75V15m0-6.75V6" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75v.008" /><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 12h.008v.008H7.5V12zm9 0h.008v.008H16.5V12z" /><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 1115 0 7.5 7.5 0 01-15 0z" fill="currentColor" opacity="0.2" /></svg><h1 class="text-xl font-orbitron font-bold text-slate-800 tracking-wide">INSIGHT</h1></div><button id="new-chat-button" title="Start New Chat" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-indigo-100 rounded-full transition-colors duration-150 focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 9a.75.75 0 00-1.5 0v2.25H9a.75.75 0 000 1.5h2.25V15a.75.75 0 001.5 0v-2.25H15a.75.75 0 000-1.5h-2.25V9z" clip-rule="evenodd" /></svg></button></header>
            <div class="chat-messages-container flex-grow p-4 md:p-5 space-y-4 overflow-y-auto relative bg-gray-50"><div id="messages-end" class="h-1"></div></div>
            <form id="chat-form" class="bg-gray-50 flex-shrink-0"><div class="p-2 md:p-3"><div class="flex flex-col bg-white rounded-xl border border-border-default focus-within:border-indigo-300 focus-within:ring-1 focus-within:ring-indigo-300 transition-all duration-200"><div id="image-pills-container" class="hidden"></div><div class="flex items-end w-full p-1.5"><button type="button" id="attach-image-button" class="flex-shrink-0 w-9 h-9 flex items-center justify-center text-gray-500 hover:text-indigo-500 rounded-full hover:bg-indigo-100 transition-colors duration-150 focus:outline-none"><i class="fas fa-paperclip text-lg"></i></button><input type="file" id="image-input" class="hidden" multiple accept="image/png, image/jpeg, image/webp"><div id="chatInput" contenteditable="true" data-placeholder="Write a message..." class="content-editable-input w-full flex-1 text-base focus:outline-none resize-none overflow-y-auto max-h-32"></div><button type="submit" id="chatSendButton" class="flex-shrink-0 w-9 h-9 flex items-center justify-center font-semibold rounded-lg bg-brand-send-active hover:bg-brand-send-hover text-white transition-all duration-150 ease-in-out transform active:animate-button-press focus:outline-none ml-2"><i class="fas fa-paper-plane text-base"></i></button></div></div></div></form>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyBx2-nzwDEmvil677vHCnfFmWk0bjc2ktc"; 
        const MULTIMODAL_MODEL_NAME = "gemini-2.5-flash-preview-04-17";
        const MAX_IMAGES_PER_MSG = 4;
        const STREAMING_SPEED_MS = 10;
        
        const A4F_API_KEY = "ddc-a4f-4bad5061267b4584a712654052a911d9";
        const A4F_API_URL = "https://api.a4f.co/v1/images/generations";
        const A4F_MODEL_NAME = "provider-1/FLUX.1-kontext-pro";

        // *** THE NEW, SIMPLIFIED MASTER PROMPT ***
        const MASTER_PROMPT = `You are 'Insight', a helpful and multi-modal AI assistant.
- Your main goal is to have natural, helpful conversations.
- For all conversational text, you MUST respond in Roman Urdu (Urdu written in the English alphabet).
- If you decide to generate an image based on the conversation, the prompt for the image generation model must be in ENGLISH.
- Your entire output MUST be ONLY a valid JSON object and nothing else. Do not add any text outside the JSON structure.
- The JSON format is: { "text_response": "Your conversational reply in Roman Urdu.", "image_generation_prompt": "A detailed, single-paragraph prompt for the image AI in ENGLISH, or null if no image is needed." }`;

        const chatMessageContainerEl = document.querySelector('.chat-messages-container');
        const chatInputEl = document.getElementById('chatInput');
        const attachImageButtonEl = document.getElementById('attach-image-button');
        const imageInputEl = document.getElementById('image-input');
        const imagePillsContainerEl = document.getElementById('image-pills-container');
        const chatFormEl = document.getElementById('chat-form');
        const newChatButtonEl = document.getElementById('new-chat-button');
        let messagesEndEl = document.getElementById('messages-end');

        let stagedImages = []; 
        let chatHistory = [];
        let isProcessing = false;
        
        function scrollToBottom() { if (messagesEndEl) messagesEndEl.scrollIntoView({ behavior: 'smooth' }); }
        
        function startNewChat() {
            chatHistory = []; stagedImages = []; isProcessing = false;
            chatMessageContainerEl.innerHTML = '<div id="messages-end" class="h-1"></div>';
            messagesEndEl = document.getElementById('messages-end');
            chatInputEl.innerHTML = ''; renderImagePills(); hideThinkingIndicator();
        }

        function addChatMessage(message, role, images = []) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full animate-fade-in-up opacity-0 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            let gridHTML = '';
            if (images.length > 0) { gridHTML = `<div class="grid gap-1 mb-1.5 ${images.length > 1 ? 'grid-cols-2' : 'grid-cols-1'}">${images.map(img => `<div class="rounded-lg overflow-hidden group relative max-w-full w-full"><img src="${img.base64}" alt="attached image" class="block w-full max-h-60 object-contain rounded-lg"></div>`).join('')}</div>`; }
            const bubble = document.createElement('div');
            bubble.className = `px-4 py-3 shadow-card relative ${role === 'user' ? 'bg-surface-user-bubble-bg text-text-primary rounded-xl rounded-br-md max-w-[85%]' : 'bg-white text-text-secondary rounded-lg border border-slate-200 w-full'}`;
            const para = document.createElement('p');
            para.className = 'text-base font-normal whitespace-pre-wrap break-words';
            para.innerHTML = message;
            bubble.innerHTML = gridHTML;
            bubble.appendChild(para);
            wrapper.appendChild(bubble);
            chatMessageContainerEl.insertBefore(wrapper, messagesEndEl);
            scrollToBottom();
            return bubble;
        }

        function showThinkingIndicator() { hideThinkingIndicator(); const i = `<div class="flex w-full justify-start animate-fade-in-up" id="dynamic-thinking-indicator"><div class="px-4 py-3 shadow-card bg-white rounded-lg border border-slate-200"><div class="flex items-center self-start"><span class="text-sm font-medium shimmer-black-text">thinking...</span></div></div></div>`; chatMessageContainerEl.insertBefore(document.createRange().createContextualFragment(i), messagesEndEl); scrollToBottom(); }
        function hideThinkingIndicator() { const i = document.getElementById('dynamic-thinking-indicator'); if (i) i.remove(); }
        
        function renderImagePills() {
            imagePillsContainerEl.innerHTML = '';
            if (stagedImages.length > 0) {
                imagePillsContainerEl.classList.remove('hidden'); imagePillsContainerEl.classList.add('image-preview-container-input');
                stagedImages.forEach((img, index) => {
                    const pill = document.createElement('div');
                    pill.className = 'relative w-14 h-14 rounded-md overflow-hidden shadow-sm group border border-gray-200';
                    pill.innerHTML = `<img src="${img.base64}" alt="${img.name}" class="w-full h-full object-cover"><button type="button" data-index="${index}" class="remove-pill absolute top-0.5 right-0.5 w-5 h-5 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-opacity focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 24 24" class="w-3 h-3" fill="currentColor"><path d="M13.414,12l6.293-6.293c0.391-0.391,0.391-1.023,0-1.414s-1.023-0.391-1.414,0L12,10.586L5.707,4.293 c-0.391-0.391-1.023-0.391-1.414,0s-0.391,1.023,0,1.414L10.586,12l-6.293,6.293c-0.391,0.391-0.391,1.023,0,1.414 C4.488,19.902,4.744,20,5,20s0.512-0.098,0.707-0.293L12,13.414l6.293,6.293C18.488,19.902,18.744,20,19,20s0.512-0.098,0.707-0.293 c0.391-0.391,0.391-1.023,0-1.414L13.414,12z"/></svg></button>`;
                    imagePillsContainerEl.appendChild(pill);
                });
                imagePillsContainerEl.querySelectorAll('.remove-pill').forEach(btn => {
                    btn.addEventListener('click', (e) => { const i = parseInt(e.currentTarget.dataset.index, 10); stagedImages.splice(i, 1); renderImagePills(); });
                });
            } else { imagePillsContainerEl.classList.add('hidden'); imagePillsContainerEl.classList.remove('image-preview-container-input'); }
        }
        
        function streamText(element, text) { return new Promise(resolve => { let i = 0; const interval = setInterval(() => { if (i < text.length) { element.innerHTML += text.charAt(i); i++; scrollToBottom(); } else { clearInterval(interval); resolve(); } }, STREAMING_SPEED_MS); }); }
        async function openDownloadPage(imageUrl) { window.open(imageUrl, '_blank'); }

        async function handleChatSubmit() {
            const userMessage = chatInputEl.innerText.trim();
            const imagesForThisMessage = [...stagedImages];
            if ((!userMessage && imagesForThisMessage.length === 0) || isProcessing) return;
            addChatMessage(userMessage, 'user', imagesForThisMessage);
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
            chatInputEl.innerHTML = ''; stagedImages = []; renderImagePills();
            await processRequest(userMessage, imagesForThisMessage);
        }

        async function processRequest(userMessage, imagesForThisMessage) {
            isProcessing = true;
            showThinkingIndicator();
            try {
                // *** THE NEW, "OFFICIAL" WAY TO BUILD THE CONVERSATION HISTORY ***
                const contents = [
                    { role: 'user', parts: [{ text: MASTER_PROMPT }] },
                    { role: 'model', parts: [{ text: 'Theek hai. Main aapki hidayat ke mutabiq kaam karunga.' }] }, // Priming the model
                    ...chatHistory, // The entire conversation history
                ];

                // Add any new images to the last user message
                const lastUserContent = contents[contents.length - 1];
                imagesForThisMessage.forEach(img => {
                    lastUserContent.parts.push({ inline_data: { mime_type: img.mime_type, data: img.base64.split(',')[1] } });
                });
                
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MULTIMODAL_MODEL_NAME}:generateContent?key=${API_KEY}`;
                const requestBody = { contents, generationConfig: { temperature: 0.7, topP: 1, topK: 40, maxOutputTokens: 2048 } };
                
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                if (!response.ok) { const e = await response.json().catch(() => ({})); throw new Error(e.error?.message || `Main API request failed with status ${response.status}`); }
                
                const responseData = await response.json();
                hideThinkingIndicator();
                let rawAiResponseText = responseData.candidates[0].content.parts[0].text;
                let aiResponse;
                try { aiResponse = JSON.parse(rawAiResponseText.replace(/^```json\s*/, '').replace(/\s*```$/, '')); } catch (e) { aiResponse = { text_response: "Mafi, mere jawab mein ek masla aa gaya hai. Kya aap dobara koshish kar sakte hain?", image_generation_prompt: null }; }
                
                const aiBubble = addChatMessage('', 'ai');
                const textPara = aiBubble.querySelector('p');
                chatHistory.push({ role: 'model', parts: [{ text: JSON.stringify(aiResponse) }] }); // Store the raw JSON response for perfect context
                await streamText(textPara, aiResponse.text_response);

                if (aiResponse.image_generation_prompt) {
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'mt-3 animate-fade-in-up';
                    imageWrapper.innerHTML = `<div class="p-2 text-sm text-center"><span class="font-medium shimmer-black-text">Generating...</span></div>`;
                    aiBubble.appendChild(imageWrapper);
                    scrollToBottom();
                    try {
                        const imageGenResponse = await fetch(A4F_API_URL, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${A4F_API_KEY}` }, body: JSON.stringify({ model: A4F_MODEL_NAME, prompt: aiResponse.image_generation_prompt, n: 1, size: "1024x1024" }) });
                        if (!imageGenResponse.ok) { const e = await imageGenResponse.json().catch(() => ({})); throw new Error(e.error?.message || `Image generation failed with status ${imageGenResponse.status}`); }
                        const imageData = await imageGenResponse.json();
                        const imageUrl = imageData.data && imageData.data[0] ? imageData.data[0].url : null;
                        if (!imageUrl) { throw new Error("Image URL not found in API response."); }
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.className = 'w-full max-w-md h-auto rounded-lg mt-1 border border-indigo-200 bg-gray-100';
                        img.onload = () => {
                            imageWrapper.innerHTML = ''; imageWrapper.appendChild(img);
                            const btn = document.createElement('button');
                            btn.className = 'block w-full text-center mt-2 text-indigo-700 text-sm font-semibold bg-indigo-100 hover:bg-indigo-200 py-1.5 rounded-md transition-colors';
                            btn.innerHTML = `<i class="fas fa-external-link-alt mr-2"></i>Open & Save`;
                            btn.onclick = () => openDownloadPage(imageUrl);
                            imageWrapper.appendChild(btn); 
                            scrollToBottom();
                        };
                        img.onerror = () => { imageWrapper.innerHTML = '<p class="text-sm text-red-700">Sorry, the generated image could not be loaded.</p>'; };
                    } catch (genError) {
                        console.error("Image Generation Error:", genError);
                        imageWrapper.innerHTML = `<p class="text-sm text-red-700 bg-red-100 p-3 rounded-lg">Sorry, an error occurred while generating the image. Please try again.</p>`;
                        chatHistory.push({ role: 'model', parts: [{ text: `{"text_response": "Sorry, an error occurred while generating the image.", "image_generation_prompt": null}` }] });
                    }
                }
            } catch (error) {
                console.error("Main Chat Error:", error);
                hideThinkingIndicator();
                const mainApiFailureMessage = "Sorry, a critical error occurred. Please try sending your message again.";
                addChatMessage(mainApiFailureMessage, 'ai');
                chatHistory.push({ role: 'model', parts: [{ text: `{"text_response": "${mainApiFailureMessage}", "image_generation_prompt": null}` }] });
            } finally {
                isProcessing = false;
            }
        }

        function handleFileSelection(files) { 
            if (!files) return; 
            for (const file of files) { 
                if (stagedImages.length >= MAX_IMAGES_PER_MSG) { alert(`You can only attach a maximum of ${MAX_IMAGES_PER_MSG} images.`); break; } 
                if (file.size > 4 * 1024 * 1024) { alert(`Image "${file.name}" is too large (max 4MB).`); continue; } 
                const reader = new FileReader(); 
                reader.onloadend = () => { 
                    stagedImages.push({ base64: reader.result, mime_type: file.type, name: file.name }); 
                    renderImagePills(); 
                }; 
                reader.readAsDataURL(file); 
            }
            imageInputEl.value = null;
        }

        function init() {
            chatFormEl.addEventListener('submit', (e) => { e.preventDefault(); handleChatSubmit(); });
            chatInputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChatSubmit(); } });
            attachImageButtonEl.addEventListener('click', () => imageInputEl.click());
            imageInputEl.addEventListener('change', (e) => handleFileSelection(e.target.files));
            newChatButtonEl.addEventListener('click', startNewChat);
            scrollToBottom();
        }

        init();
    </script>
</body>
</html>
